<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>StudyFlow â€” Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
<style>
:root{
  --indigo:#6366f1;--violet:#8b5cf6;--bg:#f6f7ff;--card:#ffffff;--text:#0f172a;
  --muted:#64748b;--border:#e2e8f0;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444
}
html.dark{--bg:#0b1220;--card:#0f172a;--text:#f1f5f9;--muted:#94a3b8;--border:#1f2a3a}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.topbar{position:sticky;top:0;z-index:40;backdrop-filter:blur(10px);background:rgba(255,255,255,.6);border-bottom:1px solid var(--border)}
html.dark .topbar{background:rgba(15,23,42,.6)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.space{justify-content:space-between}
.logo{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;color:#fff;font-weight:800;background:linear-gradient(135deg,var(--indigo),var(--violet))}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:14px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .15s ease, box-shadow .15s ease}
.btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.06)}
.btn.primary{border:none;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
.btn.ghost{background:transparent}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.04)}
.title{font-weight:800}
.muted{color:var(--muted);font-size:13px}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
@media(max-width:1000px){.g4{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.g3{grid-template-columns:1fr}.g2{grid-template-columns:1fr}}
.section{margin-top:14px}
.hidden{display:none}
.modal.hidden{display:none !important;}
.right{margin-inline-start:auto}
.hero{padding:24px 0}
.hero h1{margin:0;font-size:28px}
.hero p{margin:.3rem 0 0}
.kbd{font:600 12px/1 system-ui;background:#111;color:#fff;padding:4px 8px;border-radius:8px}
.grade,.subject{cursor:pointer;transition:.2s;border:1px solid var(--border);border-radius:14px;background:var(--card);padding:12px;text-align:center}
.grade.active{outline:2px solid #a5b4fc}
.subject.active{background:#4f46e5;color:#fff;border-color:#4f46e5}
.range{width:100%}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;font-size:12px;z-index:80}
.confetti{position:fixed;inset:0;pointer-events:none;z-index:75}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:90}
.modal .sheet{max-width:520px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.fade{animation:fade .25s ease}
@keyframes fade{from{opacity:.5;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
@keyframes pop{from{transform:scale(.96);opacity:.5}to{transform:scale(1);opacity:1}}
.pop{animation:pop .25s ease}
.link{color:#4f46e5;text-decoration:underline;cursor:pointer}
.input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.footer{padding:40px 0;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header class="topbar">
  <div class="container row space" style="padding:12px 0">
    <div class="row" style="gap:10px">
      <div class="logo">SF</div><div class="title">StudyFlow</div>
      <span class="pill" id="badgesPill">ğŸ… 0</span>
      <span class="pill" id="streakPill">ğŸ”¥ 0</span>
    </div>
    <div class="row" style="gap:8px">
      <button class="btn" id="langBtn">AR/EN</button>
      <button class="btn" id="themeBtn">Dark/Light</button>
      <span class="pill">â˜… <b id="points">0</b></span>
      <button class="btn" id="openStore">Ø§Ù„Ù…ØªØ¬Ø±</button>
      <button class="btn" id="openSettings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button class="btn primary" id="openAuth">Ø­Ø³Ø§Ø¨ÙŠ</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Landing -->
  <section id="landing" class="hero">
    <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ StudyFlow ğŸ‘‹</h1>
    <p class="muted">Ù…Ù†ØµØ© Ø¯Ø±Ø§Ø³Ø© Ø°ÙƒÙŠØ© ØªÙ†Ø¸Ù‘Ù… ÙˆÙ‚ØªÙƒ ÙˆØªÙƒØ´Ù Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙÙƒ ÙˆØªÙƒØ§ÙØ¦Ùƒ Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·.</p>
    <div class="grid g3 section">
      <div class="card fade"><b>Ø®Ø·Ø© ÙŠÙˆÙ…ÙŠØ© Ø°ÙƒÙŠØ©</b><p class="muted">ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¶Ø¹Ù Ù„Ø¯ÙŠÙƒ.</p></div>
      <div class="card fade"><b>Pomodoro + Ù…ÙƒØ§ÙØ¢Øª</b><p class="muted">Ø¬Ù„Ø³Ø§Øª ØªØ±ÙƒÙŠØ² Ù…Ø¹ Ù†Ù‚Ø§Ø· ÙˆØ´Ø§Ø±Ø§Øª.</p></div>
      <div class="card fade"><b>ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø³ÙŠØ·Ø©</b><p class="muted">ÙƒÙŠÙ ØªØªÙ‚Ø¯Ù…ØŸ ÙˆØ£ÙŠÙ† ØªØ¶Ø¹ ÙˆÙ‚ØªÙƒØŸ</p></div>
    </div>
    <div class="row section">
      <button class="btn primary" id="ctaStart">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
      <button class="btn ghost" id="ctaLearn">ØªØ¹Ø±Ù‘Ù Ø£ÙƒØ«Ø±</button>
    </div>
  </section>

  <!-- Auth Modal -->
  <section id="authModal" class="modal hidden" aria-modal="true" role="dialog">
    <div class="sheet card fade" style="position:relative">
      <button id="authCloseX" class="btn ghost" style="position:absolute;left:12px;top:12px">âœ•</button>
      <div class="row" style="gap:10px;margin-bottom:8px">
        <div class="logo">SF</div>
        <div>
          <div class="title">Ø­Ø³Ø§Ø¨ StudyFlow</div>
          <div class="muted">Ø­Ø³Ø§Ø¨ Ù…Ø­Ù„ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
        </div>
        <span class="pill right kbd">Ù…Ø­Ù„ÙŠ</span>
      </div>

      <div class="row" style="gap:6px;margin:8px 0">
        <button id="tabSignup" class="btn primary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        <button id="tabLogin"  class="btn">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <span class="right muted">Ø§Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ùˆ Esc Ù„Ù„Ø¥ØºÙ„Ø§Ù‚</span>
      </div>

      <div class="grid g2 section">
        <div id="nameWrap">
          <label class="muted">Ø§Ù„Ø§Ø³Ù…</label>
          <input id="authName" class="input" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø§Ø´Ø¯">
        </div>
        <div>
          <label class="muted">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="authUser" class="input" placeholder="username">
        </div>
        <div class="g2" style="grid-column:1 / -1;display:grid;gap:12px;grid-template-columns:1fr auto">
          <div>
            <label class="muted">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="row" style="gap:8px">
              <input id="authPass" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="flex:1">
              <button id="togglePass" class="btn">ğŸ‘</button>
            </div>
            <div id="passHint" class="muted" style="margin-top:6px"></div>
          </div>
          <div class="row" style="gap:8px;align-items:end">
            <button id="authSubmit" class="btn primary" style="min-width:140px">Ø§Ø³ØªÙ…Ø±Ø§Ø±</button>
            <button id="guestBtn" class="btn">ØªØ§Ø¨Ø¹ ÙƒØ¶ÙŠÙ</button>
          </div>
        </div>
      </div>

      <div id="authError" class="card" style="display:none;margin-top:10px;background:#fff2f2;border-color:#fecaca;color:#b91c1c">
        Ø­Ø¯Ø« Ø®Ø·Ø£ â€” ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
    </div>
  </section>

  <!-- Onboarding -->
  <section id="onboarding" class="card pop hidden">
    <div id="ob0">
      <div class="title">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø³Ø±ÙŠØ¹ (Ù£ Ø¯Ù‚Ø§Ø¦Ù‚)</div>
      <div class="muted">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.</div>
      <div id="gradeList" class="grid g4 section"></div>
      <div class="row section">
        <button class="btn primary right" id="next0">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>

    <div id="ob1" class="hidden">
      <div class="title">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ§Ø¯</div>
      <div id="subjList" class="grid g3 section"></div>
      <div class="row section">
        <button class="btn" id="back1">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn primary right" id="next1">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>

    <div id="ob2" class="hidden">
      <div class="title">Ù‚ÙŠÙ‘Ù… Ù…Ø³ØªÙˆØ§Ùƒ (1 Ø¶Ø¹ÙŠÙ â€“ 5 Ù…Ù…ØªØ§Ø²)</div>
      <div id="ratingList" class="grid section"></div>
      <div class="row section">
        <button class="btn" id="back2">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn primary right" id="next2">Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
    </div>

    <div id="ob3" class="hidden">
      <div class="title">ÙˆÙ‚Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
      <div class="row section" style="gap:10px">
        <input id="minutes" class="range" type="range" min="25" max="120" step="5" value="50">
        <span class="pill"><span id="minVal">50</span> Ø¯Ù‚ÙŠÙ‚Ø©</span>
      </div>
      <div class="muted">Ø³Ù†Ù‚Ø³Ù‘Ù… Ø§Ù„ÙˆÙ‚Øª Ù„Ø¬Ù„Ø³Ø§Øª 25 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ø¶Ø¹Ù.</div>
      <div class="row section">
        <button class="btn" id="back3">Ø±Ø¬ÙˆØ¹</button>
        <button class="btn primary right" id="finish">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø©</button>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dash" class="hidden pop">
    <div class="grid g3">
      <div class="card">
        <div class="title">Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>
        <p class="muted">Ø¬Ù„Ø³Ø© ØªØ±ÙƒÙŠØ² â€¢ Ø£Ù‚Ø±Ø¨ Ù…Ù‡Ù…Ø© â€¢ Ø±ØµÙŠØ¯ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²</p>
        <div class="row section">
          <button class="btn primary" id="startPomodoro">Ø§Ø¨Ø¯Ø£ Ø¬Ù„Ø³Ø© 25Ø«</button>
          <button class="btn" id="planWeek">ØªØ­Ø¯ÙŠØ« Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Ø§Ù„Ù…Ù‡Ø§Ù…</div>
        <div id="tasks"></div>
      </div>

      <div class="card">
        <div class="title">Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù…</div>
        <div class="grid g3 section">
          <div class="card"><div class="muted">Ø¯Ù‚Ø§Ø¦Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div><b id="kpiMin">0</b></div>
          <div class="card"><div class="muted">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø®Ø·Ø©</div><b id="kpiRate">0%</b></div>
          <div class="card"><div class="muted">Ø§Ù„Ù†Ù‚Ø§Ø·</div><b id="kpiPts">0</b></div>
        </div>
      </div>
    </div>

    <div class="card section">
      <div class="title">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (7 Ø£ÙŠØ§Ù…)</div>
      <div id="calendar" class="grid"></div>
    </div>

    <div class="card section">
      <div class="title">Pomodoro (ØªØ¬Ø±ÙŠØ¨ÙŠ 25 Ø«Ø§Ù†ÙŠØ©)</div>
      <div class="row" style="gap:10px">
        <div class="pill" id="time">00:25</div>
        <button class="btn primary" id="toggleTimer">Ø§Ø¨Ø¯Ø£</button>
        <button class="btn" id="resetTimer">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>

    <div class="card section" id="storeCard">
      <div class="row">
        <div class="title">Ø§Ù„Ù…ØªØ¬Ø±</div>
        <span class="pill right">Ø§Ù„Ø±ØµÙŠØ¯: <b id="balance">0</b></span>
      </div>
      <div id="storeItems" class="grid g3 section"></div>
    </div>

    <div class="card section hidden" id="settingsCard">
      <div class="row">
        <div class="title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        <button class="btn right" id="closeSettings">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="grid g2 section">
        <div>
          <div class="muted">Ø§Ù„Ø§Ø³Ù…</div>
          <input id="nameInput" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
        </div>
        <div>
          <div class="muted">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø¤Ù‚Øª</div>
          <select id="speed" class="input">
            <option value="demo">ØªØ¬Ø±ÙŠØ¨ÙŠ (25 Ø«Ø§Ù†ÙŠØ©)</option>
            <option value="real">Ø­Ù‚ÙŠÙ‚ÙŠ (25 Ø¯Ù‚ÙŠÙ‚Ø©)</option>
          </select>
        </div>
      </div>
      <div class="row section">
        <button class="btn" id="saveSettings">Ø­ÙØ¸</button>
        <button class="btn" id="resetAll">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  </section>
</main>

<div id="confetti" class="confetti"></div>
<div id="toast" class="toast hidden"></div>
<footer class="footer">StudyFlow Â© <span id="year"></span> â€¢ Demo â€¢ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·</footer>

<script>
// ===== Helpers =====
const $=sel=>document.querySelector(sel), $$=sel=>Array.from(document.querySelectorAll(sel));
const todayISO=(d=new Date())=>{const o=d.getTimezoneOffset();return new Date(d.getTime()-o*60000).toISOString().slice(0,10)}
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x}
function toast(m){const t=$('#toast');t.textContent=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),1800)}
function confetti(emoji='ğŸ‰'){const root=$('#confetti');root.innerHTML='';for(let i=0;i<28;i++){const s=document.createElement('div');s.textContent=Math.random()<.33?'âœ¨':emoji;Object.assign(s.style,{position:'fixed',left:Math.random()*100+'%',top:'-10px',fontSize:12+Math.random()*16+'px',transition:`transform ${900+Math.random()*1000}ms cubic-bezier(.2,.8,.2,1), opacity 1400ms`,transform:'translateY(0)',opacity:'1'});root.appendChild(s);requestAnimationFrame(()=>{s.style.transform=`translateY(${window.innerHeight+40}px) rotate(${Math.random()*180-90}deg)`;s.style.opacity='0'});setTimeout(()=>s.remove(),1800)}}
function fmt(s){const m=Math.floor(s/60),ss=s%60;return String(m).padStart(2,'0')+':'+String(ss).padStart(2,'0')}

// ===== Safe storage (fallback if localStorage blocked) =====
const __MEM__={ACCOUNTS:{},ACTIVE:null};
function canLocalStorage(){try{const k='__t__';localStorage.setItem(k,'1');localStorage.removeItem(k);return true}catch(e){return false}}
const USE_LS=canLocalStorage();
const ACCOUNTS_KEY='sf_accounts_v2', ACTIVE_KEY='sf_active_user_v2';
const getAccounts=()=> USE_LS ? JSON.parse(localStorage.getItem(ACCOUNTS_KEY)||'{}') : __MEM__.ACCOUNTS;
const setAccounts=o=>{ if(USE_LS){ try{localStorage.setItem(ACCOUNTS_KEY,JSON.stringify(o))}catch{} } else { __MEM__.ACCOUNTS=o } };
const getActive =()=> USE_LS ? (localStorage.getItem(ACTIVE_KEY)||null) : __MEM__.ACTIVE;
const setActive =u=>{ if(USE_LS){ try{localStorage.setItem(ACTIVE_KEY,u)}catch{} } else { __MEM__.ACTIVE=u } };

// ===== Demo hash (not secure, just for local demo) =====
function hashLite(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=(h*16777619)>>>0 } return 'h'+h.toString(16) }

// ===== Default state =====
function defaultState(name='Ø·Ø§Ù„Ø¨'){ return {
  profile:{name, demoSpeed:true, grade:null},
  lang:'ar', theme:'light',
  points:40, badges:[], streak:{days:0,last:todayISO()},
  store:{balance:40, items:[
    {id:'th1', title:'Ø«ÙŠÙ… Ø£Ø²Ø±Ù‚ Pro', type:'theme', cost:80},
    {id:'b1', title:'Boost x2 (24h)', type:'boost', cost:120},
    {id:'s1', title:'Ø£ØµÙˆØ§Øª ØªØ±ÙƒÙŠØ² LoFi', type:'sound', cost:70},
    {id:'m1', title:'ØµÙ†Ø¯ÙˆÙ‚ Ù…ÙØ§Ø¬Ø¢Øª', type:'mystery', cost:100},
  ], owned:[]},
  subjects:[], calendar:[], sessions:[]
}}

// ===== App state load/save =====
let state=null;
function loadUserState(){ const u=getActive(); if(!u) return null; const acc=getAccounts()[u]; return acc?acc.data:null }
function saveUserState(){ const u=getActive(); if(!u) return; const acc=getAccounts(); if(!acc[u]) acc[u]={pass:'',data:state}; else acc[u].data=state; setAccounts(acc) }
function save(){ saveUserState(); renderAll() }

// ===== Header controls =====
function renderHeader(){ $('#points').textContent=state?.points||0; $('#balance').textContent=state?.store?.balance||0; $('#badgesPill').innerHTML='ğŸ… '+(state?.badges?.length||0); $('#streakPill').innerHTML='ğŸ”¥ '+(state?.streak?.days||0) }
function setLang(l){ if(!state) return; state.lang=l; document.documentElement.lang=l; document.documentElement.dir=l==='ar'?'rtl':'ltr'; save() }
function setTheme(t){ if(!state) return; state.theme=t; document.documentElement.classList.toggle('dark',t==='dark'); save() }
$('#langBtn').onclick = ()=> setLang((state?.lang||'ar')==='ar'?'en':'ar');
$('#themeBtn').onclick= ()=> setTheme((state?.theme||'light')==='dark'?'light':'dark');

// ===== Auth modal wiring =====
const modal=$('#authModal'), btnOpenAuth=$('#openAuth'), btnCloseX=$('#authCloseX'), btnSubmit=$('#authSubmit');
const tabSignup=$('#tabSignup'), tabLogin=$('#tabLogin'), nameWrap=$('#nameWrap');
const nameInput=$('#authName'), userInput=$('#authUser'), passInput=$('#authPass'), togglePass=$('#togglePass'), errBox=$('#authError'), guestBtn=$('#guestBtn');
let authMode='signup';
function openAuth(){ modal.classList.remove('hidden'); document.body.style.overflow='hidden'; errBox.style.display='none';
  if(authMode==='signup'){ tabSignup.classList.add('primary'); tabLogin.classList.remove('primary'); nameWrap.style.display='block'; nameInput.focus() }
  else{ tabLogin.classList.add('primary'); tabSignup.classList.remove('primary'); nameWrap.style.display='none'; userInput.focus() }
}
function closeAuth(){ modal.classList.add('hidden'); document.body.style.overflow='' }
$('#ctaStart').onclick=openAuth; btnOpenAuth.onclick=openAuth; btnCloseX.onclick=closeAuth;
modal.addEventListener('click',e=>{ if(e.target===modal) closeAuth() });
document.addEventListener('keydown',e=>{ if(!modal.classList.contains('hidden')&&e.key==='Escape') closeAuth() });
tabSignup.onclick=()=>{authMode='signup';tabSignup.classList.add('primary');tabLogin.classList.remove('primary');nameWrap.style.display='block'}
tabLogin.onclick =()=>{authMode='login'; tabLogin.classList.add('primary'); tabSignup.classList.remove('primary'); nameWrap.style.display='none'}
togglePass.onclick=e=>{e.preventDefault(); const t=passInput.type==='password'?'text':'password'; passInput.type=t; togglePass.textContent=t==='text'?'ğŸ™ˆ':'ğŸ‘'}
passInput.addEventListener('input',()=>{const v=passInput.value,score=(v.length>=8)+/[A-Z]/.test(v)+/[a-z]/.test(v)+/\d/.test(v);const msgs=['Ø¶Ø¹ÙŠÙØ©','Ù…ØªÙˆØ³Ø·Ø©','Ø¬ÙŠØ¯Ø©','Ù‚ÙˆÙŠØ©'];$('#passHint').textContent=v?('Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: '+msgs[Math.max(0,score-1)]):''})

// Signup/Login core
function doSignup(name,username,password){ const acc=getAccounts(); if(acc[username]) throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯'); acc[username]={pass:hashLite(password),data:defaultState(name)}; setAccounts(acc); setActive(username); return acc[username].data }
function doLogin(username,password){ const acc=getAccounts()[username]; if(!acc) throw new Error('Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); if(acc.pass!==hashLite(password)) throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'); setActive(username); return acc.data }

btnSubmit.onclick=()=>{
  try{
    errBox.style.display='none'; btnSubmit.disabled=true; btnSubmit.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦';
    const name=(nameInput.value.trim()||'Ø·Ø§Ù„Ø¨'), username=userInput.value.trim(), password=passInput.value;
    if(!username||!password) throw new Error('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
    state = (authMode==='signup')? doSignup(name,username,password) : doLogin(username,password);
    closeAuth(); document.getElementById('authModal').classList.add('hidden');
    toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ”'); renderAll();
    if(!(state.subjects?.length)){ $('#landing').classList.add('hidden'); $('#onboarding').classList.remove('hidden'); step(0) }
  }catch(e){
    errBox.style.display='block'; errBox.textContent='Ø®Ø·Ø£: '+(e.message||'ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  }finally{
    btnSubmit.disabled=false; btnSubmit.textContent='Ø§Ø³ØªÙ…Ø±Ø§Ø±';
  }
};

// Guest flow
guestBtn.onclick=()=>{
  try{
    const uname='guest_'+Math.random().toString(36).slice(2,7);
    const acc=getAccounts(); acc[uname]={pass:hashLite('guest'),data:defaultState('Ø¶ÙŠÙ')}; setAccounts(acc); setActive(uname);
    state=acc[uname].data; closeAuth(); document.getElementById('authModal').classList.add('hidden');
    toast('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ âœ”'); renderAll(); $('#landing').classList.add('hidden'); $('#onboarding').classList.remove('hidden'); step(0);
  }catch(e){ errBox.style.display='block'; errBox.textContent='ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ: '+(e.message||'ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹') }
};

// ===== Onboarding =====
const GRADES=Array.from({length:6},(_,i)=>({id:'G'+(7+i),label:'Grade '+(7+i)}));
const SUBJECTS=['Ø±ÙŠØ§Ø¶ÙŠØ§Øª','ÙÙŠØ²ÙŠØ§Ø¡','ÙƒÙŠÙ…ÙŠØ§Ø¡','Ø£Ø­ÙŠØ§Ø¡','Ø¹Ø±Ø¨ÙŠ','Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ','ØªØ§Ø±ÙŠØ®','Ø­Ø§Ø³ÙˆØ¨'];
let selectedGrade='Grade 10', selectedSubjects=['Ø±ÙŠØ§Ø¶ÙŠØ§Øª','ÙÙŠØ²ÙŠØ§Ø¡','Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ'], ratings={};
function step(n){['#ob0','#ob1','#ob2','#ob3'].forEach((id,i)=>$(id).classList.toggle('hidden',i!==n))}
function mountGrades(){ const box=$('#gradeList'); box.innerHTML=''; GRADES.forEach(g=>{ const el=document.createElement('div'); el.className='grade'+(selectedGrade===g.label?' active':''); el.innerHTML=`<b>${g.id}</b><div class="muted">${g.label}</div>`; el.onclick=()=>{selectedGrade=g.label; mountGrades()}; box.appendChild(el) }) }
function mountSubjects(){ const box=$('#subjList'); box.innerHTML=''; SUBJECTS.forEach(n=>{ const el=document.createElement('div'); el.className='subject'+(selectedSubjects.includes(n)?' active':''); el.textContent=n; el.onclick=()=>{ selectedSubjects = selectedSubjects.includes(n)?selectedSubjects.filter(x=>x!==n):[...selectedSubjects,n]; mountSubjects() }; box.appendChild(el) }) }
function mountRatings(){ const box=$('#ratingList'); box.innerHTML=''; selectedSubjects.forEach(n=>{ const card=document.createElement('div'); card.className='card'; const val=ratings[n]||3; card.innerHTML=`<div class="row space"><b>${n}</b><div>${[1,2,3,4,5].map(r=>`<button class="btn" data-n="${n}" data-r="${r}" style="margin-inline:2px;${r===val?'background:var(--ok);color:#fff;border-color:var(--ok)':''}">${r}</button>`).join('')}</div></div>`; card.onclick=e=>{const r=parseInt(e.target.getAttribute('data-r')); const nm=e.target.getAttribute('data-n'); if(!r||!nm) return; ratings[nm]=r; mountRatings()}; box.appendChild(card) }) }
$('#next0').onclick=()=> step(1); $('#back1').onclick=()=> step(0);
$('#next1').onclick=()=> step(2); $('#back2').onclick=()=> step(1);
$('#next2').onclick=()=> step(3); $('#back3').onclick=()=> step(2);
$('#minutes').oninput=e=> $('#minVal').textContent=e.target.value;

$('#finish').onclick=()=>{
  state.profile.grade=selectedGrade;
  state.subjects = selectedSubjects.map(name=>({id:'s_'+name,name,rating:ratings[name]||3,lessons:[{id:'l1_'+name,title:'Ø¯Ø±Ø³ 1',summary:'Ù…Ù„Ø®Øµ Ù‚ØµÙŠØ±',tasks:[{id:'t1_'+name,title:'Ù…Ù‡Ù…Ø© Ù‚ØµÙŠØ±Ø©',due:todayISO(addDays(new Date(),1)),done:false}]}]}));
  const out=[], start=new Date(); const weights=state.subjects.map(s=>({id:s.id,w:6-(s.rating||3)})); const sum=weights.reduce((a,b)=>a+b.w,0)||1;
  for(let i=0;i<7;i++){const date=todayISO(addDays(start,i)); for(let k=0;k<2;k++){ let r=Math.random()*sum, chosen=weights[0].id; for(const {id,w} of weights){ if((r-=w)<=0){ chosen=id; break } } out.push({id:'sess_'+i+'_'+k,subjectId:chosen,date,minutes:25,planned:true}) }}
  state.calendar=out; save(); confetti('ğŸ¯');
  $('#onboarding').classList.add('hidden'); $('#dash').classList.remove('hidden');
};

// ===== Dashboard =====
function onboarded(){ return state && state.subjects.length>0 && state.calendar.length>0 }
function gain(pts, why){ state.points+=pts; state.store.balance+=pts; toast(`+${pts} â€¢ ${why}`) }
function renderTasks(){ const box=$('#tasks'); if(!state?.subjects?.length){ box.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… â€” Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯.</div>'; return } box.innerHTML='';
  state.subjects.forEach(sub=>{ const card=document.createElement('div'); card.className='card';
    const tasks=sub.lessons?.[0]?.tasks||[];
    card.innerHTML=`<div class="title">${sub.name}</div><div class="muted">${sub.lessons?.[0]?.summary||''}</div>
    <div style="margin-top:6px">${tasks.map(t=>`<label style="display:flex;gap:8px;align-items:center">
      <input type="checkbox" ${t.done?'checked':''} data-ids="${sub.id}|${sub.lessons[0].id}|${t.id}">
      <span ${t.done?'style="text-decoration:line-through;color:var(--muted)"':''}>${t.title}</span>
      <span class="muted right">ØªØ³Ù„ÙŠÙ…: ${t.due}</span></label>`).join('')}</div>`;
    card.addEventListener('change',e=>{
      const ids=e.target.getAttribute('data-ids'); if(!ids) return;
      const [sid,lid,tid]=ids.split('|');
      state.subjects=state.subjects.map(s=> s.id!==sid? s : ({...s,lessons:s.lessons.map(ls=> ls.id!==lid? ls : ({...ls,tasks:ls.tasks.map(tt=> tt.id!==tid? tt : ({...tt,done:!tt.done}))}))}));
      gain(20,'ØªØ³Ù„ÙŠÙ… Ù…Ù‡Ù…Ø©'); confetti('âœ…'); save()
    });
    box.appendChild(card)
  })
}
function renderCalendar(){ const box=$('#calendar'); if(!state.calendar.length){box.innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© â€” Ø£Ù†Ø´Ø¦Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>'; return} box.innerHTML='';
  const groups={}; state.calendar.forEach(s=>{(groups[s.date]??=[]).push(s)});
  Object.entries(groups).forEach(([date,sessions])=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<div class="muted">${date}</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px">
      ${sessions.map(s=>`<span class="pill">${(state.subjects.find(x=>x.id===s.subjectId)?.name)||'â€”'} â€¢ ${s.minutes}Ø¯</span>`).join('')}</div>`;
    box.appendChild(el)
  })
}
function renderKPIs(){ const weekStart=addDays(new Date(),-6); const weekly=state.sessions.filter(s=> new Date(s.date)>=weekStart);
  const weeklyMin=weekly.reduce((a,s)=>a+s.minutes,0);
  const rate=state.calendar.length? Math.round(state.sessions.filter(s=>s.completed).length/state.calendar.length*100):0;
  $('#kpiMin').textContent=weeklyMin; $('#kpiRate').textContent=rate+'%'; $('#kpiPts').textContent=state.points;
}
function renderStore(){ const box=$('#storeItems'); box.innerHTML='';
  (state.store.items||[]).forEach(it=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<div class="title">${it.title}</div><div class="muted">Ø§Ù„Ù†ÙˆØ¹: ${it.type}</div>
    <div class="row section"><span class="pill">${it.cost} Ù†Ù‚Ø·Ø©</span><button class="btn primary right">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button></div>`;
    div.querySelector('button').onclick=()=>{ if(state.store.balance<it.cost){toast('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ'); return}
      state.store.balance-=it.cost; (state.store.owned||[]).push(it); state.store.items=state.store.items.filter(x=>x.id!==it.id);
      confetti('ğŸ'); save()
    };
    box.appendChild(div)
  })
}
function planWeek(){ if(!state?.subjects?.length) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ù‹Ø§');
  const out=[], start=new Date(); const w=state.subjects.map(s=>({id:s.id,w:6-(s.rating||3)}));
  const sum=w.reduce((a,b)=>a+b.w,0)||1;
  for(let i=0;i<7;i++){const date=todayISO(addDays(start,i)); for(let k=0;k<2;k++){
    let r=Math.random()*sum, chosen=w[0].id; for(const {id, w:ww} of w){ if((r-=ww)<=0){ chosen=id; break } }
    out.push({id:'sess_'+i+'_'+k,subjectId:chosen,date,minutes:25,planned:true})
  }}
  state.calendar=out; confetti('âœ¨'); save()
}
$('#planWeek').onclick=planWeek;

// Pomodoro
let timer=null, seconds=25, real=false;
function updateTime(){ $('#time').textContent=fmt(seconds) }
function toggleTimer(){ if(timer){clearInterval(timer); timer=null; $('#toggleTimer').textContent='Ø§Ø¨Ø¯Ø£'; return}
  $('#toggleTimer').textContent='Ø¥ÙŠÙ‚Ø§Ù';
  timer=setInterval(()=>{seconds--; updateTime();
    if(seconds<=0){clearInterval(timer); timer=null; $('#toggleTimer').textContent='Ø§Ø¨Ø¯Ø£';
      seconds= real?25*60:25; updateTime();
      if(state){ state.sessions.push({date:todayISO(),minutes:25,completed:true}); state.points+=10; state.store.balance+=10; toast('+10 â€¢ Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³Ø©'); confetti('â­'); save() }
    }},1000)
}
function resetTimer(){ if(timer){clearInterval(timer); timer=null} seconds= real?25*60:25; updateTime(); $('#toggleTimer').textContent='Ø§Ø¨Ø¯Ø£' }
$('#toggleTimer').onclick=toggleTimer; $('#resetTimer').onclick=resetTimer; $('#startPomodoro').onclick=toggleTimer;

// Settings
$('#openStore').onclick=()=> $('#storeCard').scrollIntoView({behavior:'smooth'});
$('#openSettings').onclick=()=> $('#settingsCard').classList.remove('hidden');
$('#closeSettings').onclick=()=> $('#settingsCard').classList.add('hidden');
$('#saveSettings').onclick=()=>{ if(!state) return; const nm=$('#nameInput').value.trim(); const sp=$('#speed').value; if(nm) state.profile.name=nm; real=(sp==='real'); seconds= real?25*60:25; updateTime(); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸'); save() };
$('#resetAll').onclick=()=>{ if(confirm('Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠÙ…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².')){ const u=getActive(); const acc=getAccounts(); delete acc[u]; setAccounts(acc); if(USE_LS){try{localStorage.removeItem(ACTIVE_KEY)}catch{}} else {__MEM__.ACTIVE=null} location.reload() } };

// ===== Render root =====
function renderAll(){
  $('#year').textContent=new Date().getFullYear();
  if(!state){
    $('#landing').classList.remove('hidden');
    $('#onboarding').classList.add('hidden');
    $('#dash').classList.add('hidden');
  }else if(!(state.subjects?.length) || !(state.calendar?.length)){
    $('#landing').classList.add('hidden');
    $('#onboarding').classList.remove('hidden');
    $('#dash').classList.add('hidden');
    mountGrades(); mountSubjects(); mountRatings(); step(0);
  }else{
    $('#landing').classList.add('hidden');
    $('#onboarding').classList.add('hidden');
    $('#dash').classList.remove('hidden');
  }
  renderHeader(); renderTasks(); renderCalendar(); renderKPIs(); renderStore();
  $('#nameInput').value=state?.profile?.name||'';
  document.documentElement.classList.toggle('dark',(state?.theme||'light')==='dark');
  document.documentElement.lang=state?.lang||'ar';
  document.documentElement.dir =(state?.lang||'ar')==='ar'?'rtl':'ltr';
  // init timer display
  seconds = (real?25*60:25); updateTime();
}

// ===== Boot =====
state = loadUserState();
renderAll();
</script>
</body>
</html>




